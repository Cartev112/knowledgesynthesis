<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Knowledge Synthesis Platform</title>
  
  <!-- CSS Stylesheets -->
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/ingestion.css">
  <link rel="stylesheet" href="/static/css/viewing.css">
  <link rel="stylesheet" href="/static/css/query-builder.css">
  <link rel="stylesheet" href="/static/css/discovery.css">
  <link rel="stylesheet" href="/static/css/modals.css">
  <link rel="stylesheet" href="/static/css/custom-classes.css">
  
  <!-- External Dependencies -->
  <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>
<body>
  <!-- === HEADER === -->
  <div id="header">
    <h1>Knowledge Synthesis Platform</h1>
    <div id="user-info">
      <span>👤 <span id="username">Guest</span></span>
      <button onclick="window.authManager.logout()">Logout</button>
    </div>
  </div>
  
  <!-- === TAB NAVIGATION === -->
  <div id="tabs">
    <div class="tab active" onclick="window.appManager.switchTab('ingestion')">📤 Ingestion</div>
    <div class="tab" onclick="window.appManager.switchTab('viewing')">🔍 Viewing</div>
    <div class="tab" onclick="window.appManager.switchTab('discovery')">🔬 Discovery</div>
    <div class="tab" onclick="window.appManager.switchTab('query-builder')">🔎 Query Builder</div>
    <div class="tab" onclick="window.open('/review-ui', '_blank')">✅ Review Queue</div>
  </div>
  
  <!-- INGESTION TAB -->
  <div id="ingestion-tab" class="tab-content active">
    <div id="ingestion-panel">
      <div class="card">
        <h2>📤 Document Ingestion & Knowledge Extraction</h2>
        
        <div class="ingestion-grid">
          <!-- Left Column: Document Upload -->
          <div>
            <h3 class="section-heading">Document Source</h3>
            
            <div class="form-group">
              <label>Upload PDF File(s)</label>
              <label for="pdf-file" class="custom-file-upload">
                📄 Choose PDF Files
              </label>
              <input type="file" id="pdf-file" accept=".pdf" multiple onchange="window.ingestionManager.displayFileName()" />
              <div id="file-name" class="file-name-display">No files selected</div>
            </div>
            
            <div class="form-group">
              <label>Or Paste Text Directly</label>
              <textarea id="text-input" placeholder="Paste your document text here..." class="text-input-area"></textarea>
              <div class="help-text">You can paste raw text instead of uploading a file</div>
            </div>
            
            <div class="form-group">
              <label>Extraction Context (Optional)</label>
              <textarea id="extraction-context" placeholder="e.g., I'm interested in proteins and their functional relationships, drug-target interactions, or disease mechanisms..." class="extraction-context-area"></textarea>
              <div class="help-text">Guide the AI: describe what types of relationships you're most interested in</div>
            </div>
          </div>
          
          <!-- Right Column: Extraction Parameters -->
          <div>
            <h3 class="section-heading">Extraction Settings</h3>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="use-graph-context" class="checkbox-input" onchange="window.ingestionManager.toggleGraphContext()" />
                <span class="checkbox-text">Use Selected Graph as Context</span>
              </label>
              <div class="help-text" id="graph-context-help">
                Select nodes in the Viewer (Shift+Click), then check this box to find relationships that agree with, disagree with, or add to the existing knowledge
              </div>
              <div id="graph-context-status" class="graph-context-status">
                <div class="graph-context-status-inner">
                  <div>
                    <strong>Context Ready:</strong> <span id="graph-context-count">0</span> nodes selected
                  </div>
                  <button type="button" onclick="window.ingestionManager.showContextPreview()" class="preview-btn">
                    👁️ Preview
                  </button>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Max Concepts</label>
              <input type="number" id="max-concepts" value="100" min="10" max="500" />
              <div class="help-text">Maximum number of entities to extract (10-500)</div>
            </div>
            
            <div class="form-group">
              <label>Max Relationships</label>
              <input type="number" id="max-relationships" value="50" min="10" max="200" />
              <div class="help-text">Maximum number of triplets to extract (10-200)</div>
            </div>
            
            <div class="form-group">
              <label>Extraction Model</label>
              <select id="model-select">
                <option value="gpt-4o-mini">GPT-4o Mini (Fast, Cost-effective)</option>
                <option value="gpt-4o">GPT-4o (Higher Quality)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
              </select>
              <div class="help-text">AI model for knowledge extraction</div>
            </div>
            
            <div id="ingest-btn-container">
              <button class="primary" id="ingest-btn" onclick="window.ingestionManager.ingestDocument()">
                🚀 Extract Knowledge
              </button>
            </div>
            
            <div id="ingest-status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- VIEWING TAB (Graph Visualization) -->
  <div id="viewing-tab" class="tab-content">
    <div id="viewing-panel">
      <div id="cy-container">
        <div id="cy"></div>
        
        <!-- Edge Hover Tooltip -->
        <div id="edge-tooltip">
          <div class="tooltip-header">
            <span id="tooltip-source"></span>
            <span class="tooltip-relation" id="tooltip-relation"></span>
            <span id="tooltip-target"></span>
          </div>
          <div class="tooltip-info" id="tooltip-confidence"></div>
          <div class="tooltip-info" id="tooltip-significance"></div>
          <button class="tooltip-btn" id="tooltip-read-more">📖 Read More</button>
        </div>
        
        <!-- Node Hover Tooltip -->
        <div id="node-tooltip">
          <div class="tooltip-header" id="node-tooltip-label"></div>
          <div class="tooltip-info" id="node-tooltip-type"></div>
          <div class="tooltip-info" id="node-tooltip-significance"></div>
          <button class="tooltip-btn" id="node-tooltip-read-more">📖 Read More</button>
        </div>
        
        <!-- FAB Container for 2-Node Actions -->
        <div id="fab-container-2node" class="hidden">
          <div class="fab-label">2 nodes selected</div>
          <button class="fab-btn" id="fab-create-relationship" onclick="window.appManager.createRelationship()" title="Create manual relationship between nodes">
            ➕ Create Relationship
          </button>
          <button class="fab-btn" id="fab-find-path" onclick="window.appManager.findPathBetweenNodes()" title="Find shortest path between nodes">
            🔗 Find Path
          </button>
          <button class="fab-btn" id="fab-compare" onclick="window.appManager.compareNodes()" title="Compare selected nodes">
            ⚖️ Compare
          </button>
          <button class="fab-btn" id="fab-merge" onclick="window.appManager.mergeNodes()" title="Merge selected nodes">
            🔀 Merge
          </button>
        </div>
        
        <!-- Consolidated FAB Container - Bottom Left -->
        <div id="fab-container-left">
          <button id="index-toggle-btn" onclick="toggleIndex()" title="Toggle Index">📋</button>
          <button id="legend-toggle-btn" onclick="toggleLegend()" title="Visual Guide">📊</button>
          <button id="export-toggle-btn" onclick="window.appManager.openExport()" title="Export Graph">💾</button>
          <button id="review-toggle-btn" onclick="window.appManager.openReviewQueue()" title="Review Queue">✅</button>
        </div>
      </div>
    </div>
    
    <!-- Index Panel -->
    <div id="index-panel" class="hidden">
      <div class="index-header">
        <h3 class="index-title">📋 Graph Index</h3>
        <div class="index-count" id="index-count">0 concepts, 0 relationships, 0 documents</div>
      </div>
      
      <!-- Index Filters -->
      <div class="index-filters">
        <input type="text" id="index-search" class="index-search-input" placeholder="🔍 Search..." />
        <select id="index-view-filter" onchange="filterIndex()" class="index-filter-select">
          <option value="all">All Items</option>
          <option value="documents">Documents Only</option>
          <option value="concepts">Concepts Only</option>
          <option value="relationships">Relationships Only</option>
        </select>
        <select id="index-type-filter" onchange="filterIndex()" class="index-filter-select">
          <option value="">All Types</option>
        </select>
      </div>
      
      <div class="index-section" id="documents-section">
        <div class="index-section-title collapsible" onclick="window.viewingManager.indexManager.toggleSection('documents')">
          <span class="section-arrow">▼</span>
          📄 Documents (<span id="documents-count">0</span>)
        </div>
        <div id="documents-list" class="index-section-content"></div>
      </div>
      
      <div class="index-section" id="concepts-section">
        <div class="index-section-title collapsible" onclick="window.viewingManager.indexManager.toggleSection('concepts')">
          <span class="section-arrow">▼</span>
          🔵 Concepts (<span id="concepts-count">0</span>)
        </div>
        <ul class="index-list index-section-content" id="concepts-list"></ul>
      </div>
      
      <div class="index-section" id="relationships-section">
        <div class="index-section-title collapsible" onclick="window.viewingManager.indexManager.toggleSection('relationships')">
          <span class="section-arrow">▼</span>
          🔗 Relationships (<span id="relationships-count">0</span>)
        </div>
        <div id="relationships-list" class="index-section-content"></div>
      </div>
    </div>

  </div>

  <!-- Edge Details Modal -->
  <div id="edge-modal-overlay">
    <div id="edge-modal">
      <div class="modal-header">
        <h2 class="modal-title">Relationship Details</h2>
        <button class="modal-close" onclick="closeEdgeModal()">×</button>
      </div>
      <div class="modal-body" id="edge-modal-content"></div>
    </div>
  </div>
  
  <!-- Node Details Modal -->
  <div id="node-modal-overlay">
    <div id="node-modal">
      <div class="modal-header">
        <h2 class="modal-title">Node Details</h2>
        <button class="modal-close" onclick="closeNodeModal()">×</button>
      </div>
      <div class="modal-body" id="node-modal-content"></div>
    </div>
  </div>
  
  <!-- Document Details Modal -->
  <div id="document-modal-overlay">
    <div id="document-modal">
      <div class="modal-header">
        <h2 class="modal-title">Document Details</h2>
        <button class="modal-close" onclick="closeDocumentModal()">×</button>
      </div>
      <div class="modal-body" id="document-modal-content"></div>
    </div>
  </div>
  
  <!-- Create Relationship Modal -->
  <div id="create-edge-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Create Manual Relationship</h2>
        <button class="modal-close" onclick="window.appManager.closeCreateRelationshipModal()">×</button>
      </div>
      <div class="modal-body">
        <form id="create-edge-form" onsubmit="window.appManager.saveManualRelationship(event)">
          <div class="form-group">
            <label>From (Subject)</label>
            <input type="text" id="manual-from" readonly class="readonly-input" />
          </div>
          
          <div class="form-group">
            <label>Relationship Type</label>
            <input type="text" id="manual-relation" list="manual-predicate-suggestions" required placeholder="e.g., targets, inhibits, activates..." />
            <datalist id="manual-predicate-suggestions">
              <option value="targets">
              <option value="inhibits">
              <option value="activates">
              <option value="regulates">
              <option value="binds_to">
              <option value="causes">
              <option value="treats">
              <option value="associated_with">
              <option value="located_in">
              <option value="part_of">
            </datalist>
          </div>
          
          <div class="form-group">
            <label>To (Object)</label>
            <input type="text" id="manual-to" readonly class="readonly-input" />
          </div>
          
          <div class="form-group">
            <label>Evidence / Source Text</label>
            <textarea id="manual-evidence" required class="evidence-textarea" placeholder="Provide the text or citation that supports this relationship..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Confidence (0-1)</label>
            <input type="number" id="manual-confidence" min="0" max="1" step="0.1" value="0.9" />
          </div>
          
          <div class="modal-footer">
            <button type="button" onclick="window.appManager.closeCreateRelationshipModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Create Relationship</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Ingestion Progress Modal -->
  <div id="progress-modal" class="modal-overlay">
    <div class="modal-container progress-modal-container">
      <div class="modal-header">
        <h2 class="modal-title">🚀 Knowledge Extraction in Progress</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeProgressModal()">×</button>
      </div>
      <div class="modal-body">
        <!-- Email notification message -->
        <div class="email-notification">
          <div class="email-notification-inner">
            <span class="email-icon">📧</span>
            <div class="email-text">
              <strong>Processing in background</strong><br>
              You'll receive an email summary with all extracted relationships when complete. Feel free to close this modal and continue working.
            </div>
          </div>
        </div>
        
        <!-- Overall progress -->
        <div class="modal-section">
          <div class="progress-header-row">
            <span class="progress-status" id="progress-modal-status">Queuing files...</span>
            <span class="progress-count" id="progress-modal-count">0 / 0</span>
          </div>
          <div class="progress-bar-wrapper">
            <div id="progress-modal-bar" class="progress-bar-inner"></div>
          </div>
          <div class="progress-percentage" id="progress-modal-percentage">0%</div>
        </div>
        
        <!-- File list -->
        <div class="modal-section">
          <div class="modal-section-title">Files</div>
          <div id="progress-modal-files" class="progress-files-list"></div>
        </div>
        
        <!-- Summary stats -->
        <div id="progress-modal-summary" class="progress-summary">
          <div class="progress-summary-title">Summary</div>
          <div class="progress-summary-grid">
            <div>✓ Successful: <strong id="progress-summary-success">0</strong></div>
            <div>✗ Failed: <strong id="progress-summary-failed">0</strong></div>
            <div class="progress-summary-full">📊 Total Relationships: <strong id="progress-summary-triplets">0</strong></div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" onclick="window.ingestionManager.closeProgressModal()" class="btn-primary" id="progress-modal-close-btn">
            Continue in Background
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Graph Context Preview Modal -->
  <div id="context-preview-modal" class="modal-overlay">
    <div class="modal-container context-preview-container">
      <div class="modal-header">
        <h2 class="modal-title">📊 Graph Context Preview</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeContextPreview()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <div class="modal-section-title">Selected Nodes (<span id="preview-node-count">0</span>)</div>
          <div id="preview-nodes-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Relationships (<span id="preview-rel-count">0</span>)</div>
          <div id="preview-relationships-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Neighbor Entities (<span id="preview-neighbor-count">0</span>)</div>
          <div id="preview-neighbors-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Context Text</div>
          <div class="modal-section-content">
            <div class="preview-raw-text" id="preview-raw-text"></div>
            <div class="preview-token-info">
              Estimated tokens: <strong id="preview-token-count">0</strong>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" onclick="window.ingestionManager.copyContextText()" class="btn-secondary">📋 Copy Text</button>
          <button type="button" onclick="window.ingestionManager.closeContextPreview()" class="btn-primary">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Visual Legend Modal -->
  <div id="legend-modal-overlay">
    <div id="legend-modal">
      <div class="modal-header">
        <h2 class="modal-title">📊 Visual Guide</h2>
        <button class="modal-close" onclick="closeLegendModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="legend-section">
          <div class="modal-section-title">Node Colors</div>
          <div class="modal-section-content">
            <div class="legend-item">
              <div class="legend-color legend-color-default"></div>
              <span>Default Entity</span>
            </div>
            <div class="legend-item">
              <div class="legend-color legend-color-highlighted"></div>
              <span>Searched/Highlighted</span>
            </div>
            <div class="legend-item">
              <div class="legend-color legend-color-neighbor"></div>
              <span>Neighbor</span>
            </div>
            <div class="legend-item">
              <div class="legend-color legend-color-selected"></div>
              <span>Multi-Selected</span>
            </div>
          </div>
        </div>
        
        <div class="legend-section">
          <div class="modal-section-title">Node Size</div>
          <div class="modal-section-content">
            <div class="legend-item">
              <span class="legend-size-small">●</span>
              <span>Low significance (1-2)</span>
            </div>
            <div class="legend-item">
              <span class="legend-size-medium">●</span>
              <span>Medium significance (3)</span>
            </div>
            <div class="legend-item">
              <span class="legend-size-large">●</span>
              <span>High significance (4-5)</span>
            </div>
          </div>
        </div>
        
        <div class="legend-section">
          <div class="modal-section-title">Edge Styles</div>
          <div class="modal-section-content">
            <div class="legend-item">
              <div class="legend-line legend-line-unverified"></div>
              <span>Unverified</span>
            </div>
            <div class="legend-item">
              <div class="legend-line legend-line-verified"></div>
              <span>Verified</span>
            </div>
            <div class="legend-item">
              <div class="legend-line legend-line-incorrect"></div>
              <span>Incorrect</span>
            </div>
            <div class="legend-item">
              <div class="legend-line legend-line-negative"></div>
              <span>Negative Polarity</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- DISCOVERY TAB -->
  <div id="discovery-tab" class="tab-content">
    <div class="discovery-container">
      <div class="discovery-header">
        <h2>🔬 Document Discovery</h2>
        <p>Search PubMed, ArXiv, and Semantic Scholar for relevant research papers</p>
      </div>
      
      <div class="discovery-search-panel">
        <form class="discovery-search-form" id="discovery-search-form">
          <div class="discovery-form-group">
            <label for="discovery-query">Research Query</label>
            <input 
              type="text" 
              id="discovery-query" 
              placeholder="e.g., BRAF inhibitors in melanoma, machine learning protein folding"
              required
            />
          </div>
          
          <div class="discovery-search-options">
            <div class="discovery-form-group">
              <label for="discovery-max-results">Max Results</label>
              <input type="number" id="discovery-max-results" value="20" min="1" max="50" />
            </div>
            
            <div class="discovery-form-group">
              <label>Sources</label>
              <div style="display: flex; gap: 15px; margin-top: 5px; flex-wrap: wrap;">
                <div class="discovery-checkbox-group">
                  <input type="checkbox" id="discovery-source-pubmed" checked />
                  <label for="discovery-source-pubmed">PubMed</label>
                </div>
                <div class="discovery-checkbox-group">
                  <input type="checkbox" id="discovery-source-arxiv" checked />
                  <label for="discovery-source-arxiv">ArXiv</label>
                </div>
                <div class="discovery-checkbox-group">
                  <input type="checkbox" id="discovery-source-semantic-scholar" checked />
                  <label for="discovery-source-semantic-scholar">Semantic Scholar</label>
                </div>
              </div>
            </div>
            
            <div class="discovery-form-group">
              <div class="discovery-checkbox-group">
                <input type="checkbox" id="discovery-use-semantic-ranking" checked />
                <label for="discovery-use-semantic-ranking">Use Semantic Ranking (AI-powered relevance)</label>
              </div>
            </div>
          </div>
          
          <div class="discovery-button-group">
            <button type="submit" class="discovery-btn discovery-btn-primary">🔍 Search Papers</button>
            <button type="button" class="discovery-btn discovery-btn-secondary" onclick="window.discoveryManager?.searchWithGraphContext()">
              🧠 Search with Graph Context
            </button>
          </div>
        </form>
      </div>
      
      <div class="discovery-results-panel" id="discovery-results-panel">
        <div class="discovery-results-header">
          <h3>Search Results</h3>
          <span class="discovery-results-count" id="discovery-results-count">0 papers found</span>
        </div>
        
        <div id="discovery-results-container"></div>
      </div>
      
      <div class="discovery-bulk-actions" id="discovery-bulk-actions">
        <div>
          <strong id="discovery-selected-count">0</strong> papers selected
        </div>
        <div class="discovery-button-group">
          <button class="discovery-btn discovery-btn-secondary discovery-btn-small" onclick="window.discoveryManager?.clearSelection()">Clear Selection</button>
          <button class="discovery-btn discovery-btn-primary discovery-btn-small" onclick="window.discoveryManager?.ingestSelected()">Ingest Selected Papers</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- QUERY BUILDER TAB -->
  <div id="query-builder-tab" class="tab-content">
    <div id="query-builder-content">
      <!-- Content will be populated by query-builder.js -->
    </div>
  </div>
  
  <!-- JavaScript Modules (ES6 Modules) -->
  <script src="/static/js/discovery/discovery.js"></script>
  <script type="module" src="/static/js/main.js"></script>
</body>
</html>
