<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Knowledge Synthesis Platform</title>
  
  <!-- CSS Stylesheets -->
  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/ingestion.css">
  <link rel="stylesheet" href="/static/css/viewing.css">
  <link rel="stylesheet" href="/static/css/query-builder.css">
  <link rel="stylesheet" href="/static/css/modals.css">
  
  <!-- External Dependencies -->
  <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>
<body>
  <!-- === HEADER === -->
  <div id="header">
    <h1>Knowledge Synthesis Platform</h1>
    <div id="user-info">
      <span>👤 <span id="username">Guest</span></span>
      <button onclick="window.authManager.logout()">Logout</button>
    </div>
  </div>
  
  <!-- === TAB NAVIGATION === -->
  <div id="tabs">
    <div class="tab active" onclick="window.appManager.switchTab('ingestion')">📤 Ingestion</div>
    <div class="tab" onclick="window.appManager.switchTab('viewing')">🔍 Viewing</div>
    <div class="tab" onclick="window.appManager.switchTab('query-builder')">🔎 Query Builder</div>
    <div class="tab" onclick="window.open('/review-ui', '_blank')">✅ Review Queue</div>
  </div>
  
  <!-- INGESTION TAB -->
  <div id="ingestion-tab" class="tab-content active">
    <div id="ingestion-panel">
      <div class="card">
        <h2>📤 Document Ingestion & Knowledge Extraction</h2>
        
        <div class="ingestion-grid">
          <!-- Left Column: Document Upload -->
          <div>
            <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #374151; font-weight: 600;">Document Source</h3>
            
            <div class="form-group">
              <label>Upload PDF File(s)</label>
              <label for="pdf-file" class="custom-file-upload">
                📄 Choose PDF Files
              </label>
              <input type="file" id="pdf-file" accept=".pdf" multiple onchange="window.ingestionManager.displayFileName()" />
              <div id="file-name" class="file-name-display">No files selected</div>
            </div>
            
            <div class="form-group">
              <label>Or Paste Text Directly</label>
              <textarea id="text-input" placeholder="Paste your document text here..." style="min-height: 90px;"></textarea>
              <div class="help-text">You can paste raw text instead of uploading a file</div>
            </div>
            
            <div class="form-group">
              <label>Extraction Context (Optional)</label>
              <textarea id="extraction-context" placeholder="e.g., I'm interested in proteins and their functional relationships, drug-target interactions, or disease mechanisms..." style="min-height: 80px;"></textarea>
              <div class="help-text">Guide the AI: describe what types of relationships you're most interested in</div>
            </div>
          </div>
          
          <!-- Right Column: Extraction Parameters -->
          <div>
            <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #374151; font-weight: 600;">Extraction Settings</h3>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                <input type="checkbox" id="use-graph-context" style="width: auto; margin-right: 10px; cursor: pointer;" onchange="window.ingestionManager.toggleGraphContext()" />
                <span style="font-weight: 600;">Use Selected Graph as Context</span>
              </label>
              <div class="help-text" id="graph-context-help" style="color: #9ca3af;">
                Select nodes in the Viewer (Shift+Click), then check this box to find relationships that agree with, disagree with, or add to the existing knowledge
              </div>
              <div id="graph-context-status" style="display: none; margin-top: 8px; padding: 10px; background: #dbeafe; border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 13px; color: #1e40af;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>Context Ready:</strong> <span id="graph-context-count">0</span> nodes selected
                  </div>
                  <button type="button" onclick="window.ingestionManager.showContextPreview()" style="padding: 4px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;">
                    👁️ Preview
                  </button>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Max Concepts</label>
              <input type="number" id="max-concepts" value="100" min="10" max="500" />
              <div class="help-text">Maximum number of entities to extract (10-500)</div>
            </div>
            
            <div class="form-group">
              <label>Max Relationships</label>
              <input type="number" id="max-relationships" value="50" min="10" max="200" />
              <div class="help-text">Maximum number of triplets to extract (10-200)</div>
            </div>
            
            <div class="form-group">
              <label>Extraction Model</label>
              <select id="model-select">
                <option value="gpt-4o-mini">GPT-4o Mini (Fast, Cost-effective)</option>
                <option value="gpt-4o">GPT-4o (Higher Quality)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
              </select>
              <div class="help-text">AI model for knowledge extraction</div>
            </div>
            
            <div id="ingest-btn-container">
              <button class="primary" id="ingest-btn" onclick="window.ingestionManager.ingestDocument()">
                🚀 Extract Knowledge
              </button>
            </div>
            
            <div id="ingest-status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- VIEWING TAB (Graph Visualization) -->
  <div id="viewing-tab" class="tab-content">
    <div id="viewing-panel">
      <div id="cy-container">
        <div id="cy"></div>
        
        <!-- Edge Hover Tooltip -->
        <div id="edge-tooltip">
          <div class="tooltip-header">
            <span id="tooltip-source"></span>
            <span class="tooltip-relation" id="tooltip-relation"></span>
            <span id="tooltip-target"></span>
          </div>
          <div class="tooltip-info" id="tooltip-confidence"></div>
          <div class="tooltip-info" id="tooltip-significance"></div>
          <button class="tooltip-btn" id="tooltip-read-more">📖 Read More</button>
        </div>
        
        <!-- Node Hover Tooltip -->
        <div id="node-tooltip">
          <div class="tooltip-header" id="node-tooltip-label"></div>
          <div class="tooltip-info" id="node-tooltip-type"></div>
          <div class="tooltip-info" id="node-tooltip-significance"></div>
          <button class="tooltip-btn" id="node-tooltip-read-more">📖 Read More</button>
        </div>
        
        <!-- FAB Container for 2-Node Actions -->
        <div id="fab-container-2node" class="hidden">
          <div class="fab-label">2 nodes selected</div>
          <button class="fab-btn" id="fab-create-relationship" onclick="window.appManager.createRelationship()" title="Create manual relationship between nodes">
            ➕ Create Relationship
          </button>
          <button class="fab-btn" id="fab-find-path" onclick="window.appManager.findPathBetweenNodes()" title="Find shortest path between nodes">
            🔗 Find Path
          </button>
          <button class="fab-btn" id="fab-compare" onclick="window.appManager.compareNodes()" title="Compare selected nodes">
            ⚖️ Compare
          </button>
          <button class="fab-btn" id="fab-merge" onclick="window.appManager.mergeNodes()" title="Merge selected nodes">
            🔀 Merge
          </button>
        </div>
        
        <!-- Always-visible FAB Container -->
        <div id="fab-container-always" class="fab-container-always">
          <button class="fab-round" onclick="window.appManager.openExport()" title="Export Graph">
            <span>💾</span>
            <span class="fab-tooltip">Export</span>
          </button>
          <button class="fab-round" onclick="window.appManager.openReviewQueue()" title="Review Queue">
            <span>✅</span>
            <span class="fab-tooltip">Review Queue</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Index Panel -->
    <div id="index-panel" class="hidden">
      <div class="index-header">
        <h3 class="index-title">📋 Graph Index</h3>
        <div class="index-count" id="index-count">0 concepts, 0 relationships, 0 documents</div>
      </div>
      
      <!-- Index Filters -->
      <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
        <select id="index-view-filter" onchange="filterIndex()" style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; margin-bottom: 8px;">
          <option value="all">All Items</option>
          <option value="documents">Documents Only</option>
          <option value="concepts">Concepts Only</option>
          <option value="relationships">Relationships Only</option>
        </select>
        <select id="index-type-filter" onchange="filterIndex()" style="width: 100%; padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
          <option value="">All Types</option>
        </select>
      </div>
      
      <div class="index-section" id="documents-section">
        <div class="index-section-title">
          📄 Documents (<span id="documents-count">0</span>)
        </div>
        <div id="documents-list"></div>
      </div>
      
      <div class="index-section" id="concepts-section">
        <div class="index-section-title">
          🔵 Concepts (<span id="concepts-count">0</span>)
        </div>
        <ul class="index-list" id="concepts-list"></ul>
      </div>
      
      <div class="index-section" id="relationships-section">
        <div class="index-section-title">
          🔗 Relationships (<span id="relationships-count">0</span>)
        </div>
        <div id="relationships-list"></div>
      </div>
    </div>

    <!-- Index Toggle Button -->
    <button id="index-toggle-btn" onclick="toggleIndex()" title="Toggle Index">📋</button>
    
    <!-- Legend Toggle Button -->
    <button id="legend-toggle-btn" onclick="toggleLegend()" title="Visual Guide">📊</button>
  </div>

  <!-- Edge Details Modal -->
  <div id="edge-modal-overlay">
    <div id="edge-modal">
      <div class="modal-header">
        <h2 class="modal-title">Relationship Details</h2>
        <button class="modal-close" onclick="closeEdgeModal()">×</button>
      </div>
      <div class="modal-body" id="edge-modal-content"></div>
    </div>
  </div>
  
  <!-- Node Details Modal -->
  <div id="node-modal-overlay">
    <div id="node-modal">
      <div class="modal-header">
        <h2 class="modal-title">Node Details</h2>
        <button class="modal-close" onclick="closeNodeModal()">×</button>
      </div>
      <div class="modal-body" id="node-modal-content"></div>
    </div>
  </div>
  
  <!-- Document Details Modal -->
  <div id="document-modal-overlay">
    <div id="document-modal">
      <div class="modal-header">
        <h2 class="modal-title">Document Details</h2>
        <button class="modal-close" onclick="closeDocumentModal()">×</button>
      </div>
      <div class="modal-body" id="document-modal-content"></div>
    </div>
  </div>
  
  <!-- Create Relationship Modal -->
  <div id="create-edge-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Create Manual Relationship</h2>
        <button class="modal-close" onclick="window.appManager.closeCreateRelationshipModal()">×</button>
      </div>
      <div class="modal-body">
        <form id="create-edge-form" onsubmit="window.appManager.saveManualRelationship(event)">
          <div class="form-group">
            <label>From (Subject)</label>
            <input type="text" id="manual-from" readonly style="background: #f9fafb;" />
          </div>
          
          <div class="form-group">
            <label>Relationship Type</label>
            <input type="text" id="manual-relation" list="manual-predicate-suggestions" required placeholder="e.g., targets, inhibits, activates..." />
            <datalist id="manual-predicate-suggestions">
              <option value="targets">
              <option value="inhibits">
              <option value="activates">
              <option value="regulates">
              <option value="binds_to">
              <option value="causes">
              <option value="treats">
              <option value="associated_with">
              <option value="located_in">
              <option value="part_of">
            </datalist>
          </div>
          
          <div class="form-group">
            <label>To (Object)</label>
            <input type="text" id="manual-to" readonly style="background: #f9fafb;" />
          </div>
          
          <div class="form-group">
            <label>Evidence / Source Text</label>
            <textarea id="manual-evidence" required style="min-height: 80px;" placeholder="Provide the text or citation that supports this relationship..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Confidence (0-1)</label>
            <input type="number" id="manual-confidence" min="0" max="1" step="0.1" value="0.9" />
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
            <button type="button" onclick="window.appManager.closeCreateRelationshipModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Create Relationship</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Ingestion Progress Modal -->
  <div id="progress-modal" class="modal-overlay">
    <div class="modal-container" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">🚀 Knowledge Extraction in Progress</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeProgressModal()">×</button>
      </div>
      <div class="modal-body">
        <!-- Email notification message -->
        <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
          <div style="display: flex; align-items: start; gap: 10px;">
            <span style="font-size: 20px;">📧</span>
            <div style="font-size: 13px; color: #1e40af;">
              <strong>Processing in background</strong><br>
              You'll receive an email summary with all extracted relationships when complete. Feel free to close this modal and continue working.
            </div>
          </div>
        </div>
        
        <!-- Overall progress -->
        <div class="modal-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; color: #374151;" id="progress-modal-status">Queuing files...</span>
            <span style="font-size: 13px; color: #6b7280;" id="progress-modal-count">0 / 0</span>
          </div>
          <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
            <div id="progress-modal-bar" style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s;"></div>
          </div>
          <div style="text-align: center; margin-top: 4px; font-size: 12px; color: #6b7280;" id="progress-modal-percentage">0%</div>
        </div>
        
        <!-- File list -->
        <div class="modal-section">
          <div class="modal-section-title">Files</div>
          <div id="progress-modal-files" style="max-height: 300px; overflow-y: auto;"></div>
        </div>
        
        <!-- Summary stats -->
        <div id="progress-modal-summary" style="display: none; margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 6px;">
          <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">Summary</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
            <div>✓ Successful: <strong id="progress-summary-success">0</strong></div>
            <div>✗ Failed: <strong id="progress-summary-failed">0</strong></div>
            <div style="grid-column: 1 / -1;">📊 Total Relationships: <strong id="progress-summary-triplets">0</strong></div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <button type="button" onclick="window.ingestionManager.closeProgressModal()" class="btn-primary" id="progress-modal-close-btn">
            Continue in Background
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Graph Context Preview Modal -->
  <div id="context-preview-modal" class="modal-overlay">
    <div class="modal-container" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">📊 Graph Context Preview</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeContextPreview()">×</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <div class="modal-section-title">Selected Nodes (<span id="preview-node-count">0</span>)</div>
          <div id="preview-nodes-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Relationships (<span id="preview-rel-count">0</span>)</div>
          <div id="preview-relationships-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Neighbor Entities (<span id="preview-neighbor-count">0</span>)</div>
          <div id="preview-neighbors-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Context Text</div>
          <div class="modal-section-content">
            <div style="background: #f9fafb; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap;" id="preview-raw-text"></div>
            <div style="margin-top: 8px; font-size: 13px; color: #6b7280;">
              Estimated tokens: <strong id="preview-token-count">0</strong>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
          <button type="button" onclick="window.ingestionManager.copyContextText()" class="btn-secondary">📋 Copy Text</button>
          <button type="button" onclick="window.ingestionManager.closeContextPreview()" class="btn-primary">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Visual Legend Modal -->
  <div id="legend-modal-overlay">
    <div id="legend-modal">
      <div class="modal-header">
        <h2 class="modal-title">📊 Visual Guide</h2>
        <button class="modal-close" onclick="closeLegendModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="legend-section">
          <div class="modal-section-title">Node Colors</div>
          <div class="modal-section-content">
            <div class="legend-item">
              <div class="legend-color" style="background: #667eea;"></div>
              <span>Default Entity</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #dc2626;"></div>
              <span>Searched/Highlighted</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f59e0b;"></div>
              <span>Neighbor</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #8b5cf6;"></div>
              <span>Multi-Selected</span>
            </div>
          </div>
        </div>
        
        <div class="legend-section">
          <div class="modal-section-title">Node Size</div>
          <div class="modal-section-content">
            <div class="legend-item">
              <span style="font-size: 10px;">●</span>
              <span>Low significance (1-2)</span>
            </div>
            <div class="legend-item">
              <span style="font-size: 14px;">●</span>
              <span>Medium significance (3)</span>
            </div>
            <div class="legend-item">
              <span style="font-size: 18px;">●</span>
              <span>High significance (4-5)</span>
            </div>
          </div>
        </div>
        
        <div class="legend-section">
          <div class="modal-section-title">Edge Styles</div>
          <div class="modal-section-content">
            <div class="legend-item">
              <div class="legend-line" style="background: #94a3b8;"></div>
              <span>Unverified</span>
            </div>
            <div class="legend-item">
              <div class="legend-line" style="background: #059669;"></div>
              <span>Verified</span>
            </div>
            <div class="legend-item">
              <div class="legend-line" style="background: #dc2626; border-style: dashed;"></div>
              <span>Incorrect</span>
            </div>
            <div class="legend-item">
              <div class="legend-line" style="background: #94a3b8; border-style: dotted;"></div>
              <span>Negative Polarity</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- QUERY BUILDER TAB -->
  <div id="query-builder-tab" class="tab-content">
    <div id="query-builder-content">
      <!-- Content will be populated by query-builder.js -->
    </div>
  </div>
  
  <!-- JavaScript Modules (ES6 Modules) -->
  <script type="module" src="/static/js/main.js"></script>
</body>
</html>
