<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Knowledge Synthesis Platform</title>
  
  <!-- CSS Stylesheets -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/ingestion.css">
  <link rel="stylesheet" href="/css/viewing.css">
  <link rel="stylesheet" href="/css/query-builder.css">
  <link rel="stylesheet" href="/css/ai-query.css">
  <link rel="stylesheet" href="/css/discovery.css">
  <link rel="stylesheet" href="/css/modals.css">
  <link rel="stylesheet" href="/css/custom-classes.css">
  <link rel="stylesheet" href="/css/graph3d.css">
  <link rel="stylesheet" href="/css/workspace-switcher.css">
  <link rel="stylesheet" href="/css/workspaces.css">
  
  <!-- External Dependencies -->
  <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
</head>
<body>
  <!-- === HEADER === -->
  <div id="header">
    <h1>Knowledge Synthesis Platform</h1>
    <div id="workspace-switcher-container"></div>
    <div id="user-info">
      <span>üë§ <span id="username">Guest</span></span>
      <button onclick="window.authManager.logout()">Logout</button>
    </div>
  </div>
  
  <!-- === TAB NAVIGATION === -->
  <div id="tabs">
    <div class="tab active" onclick="window.appManager.switchTab('ingestion')">üì§ Ingestion</div>
    <div class="tab" onclick="window.appManager.switchTab('viewing')">üîç Viewing</div>
    <div class="tab" onclick="window.appManager.switchTab('discovery')">üî¨ Discovery</div>
    <div class="tab" onclick="window.appManager.switchTab('ai-query')">ü§ñ AI Query</div>
    <div class="tab" onclick="window.open('/review-ui', '_blank')">‚úÖ Review Queue</div>
  </div>
  
  <!-- INGESTION TAB -->
  <div id="ingestion-tab" class="tab-content active">
    <div id="ingestion-panel">
      <div class="card">
        <h2>üì§ Document Ingestion & Knowledge Extraction</h2>
        
        <div class="ingestion-grid">
          <!-- Left Column: Document Upload -->
          <div>
            <h3 class="section-heading">Document Source</h3>
            
            <div class="form-group">
              <label>Upload PDF File(s)</label>
              <label for="pdf-file" class="custom-file-upload">
                üìÑ Choose PDF Files
              </label>
              <input type="file" id="pdf-file" accept=".pdf" multiple onchange="window.ingestionManager.displayFileName()" />
              <div id="file-name" class="file-name-display">No files selected</div>
            </div>
            
            <div class="form-group">
              <label>Or Paste Text Directly</label>
              <textarea id="text-input" placeholder="Paste your document text here..." class="text-input-area"></textarea>
              <div class="help-text">You can paste raw text instead of uploading a file</div>
            </div>
            
            <div class="form-group">
              <button type="button" class="btn-secondary" onclick="window.ingestionManager.openContextConfig()" style="width: 100%; padding: 12px; font-size: 14px; font-weight: 600;">
                üéØ Configure Context
              </button>
              <div class="help-text">Configure graph and user context used during extraction</div>
            </div>
          </div>
          
          <!-- Right Column: Extraction Parameters -->
          <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 class="section-heading" style="margin: 0;">Extraction Settings</h3>
              <button type="button" class="btn-gear-icon" onclick="window.ingestionManager.openAdvancedConfig()" title="Advanced Extraction Settings">
                ‚öôÔ∏è
              </button>
            </div>
            
            <div class="form-group">
              <div class="help-text">
                Select concepts, relationships, or documents to guide extraction
              </div>
              <div id="graph-context-status" class="graph-context-status">
                <div class="graph-context-status-inner">
                  <div id="context-summary-text" style="font-size: 13px; color: #374151;">
                    No context configured
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label>Max Concepts</label>
              <input type="number" id="max-concepts" value="100" min="10" max="500" />
              <div class="help-text">Maximum number of entities to extract (10-500)</div>
            </div>
            
            <div class="form-group">
              <label>Max Relationships</label>
              <input type="number" id="max-relationships" value="50" min="10" max="200" />
              <div class="help-text">Maximum number of triplets to extract (10-200)</div>
            </div>
            
            <div class="form-group">
              <label>Extraction Model</label>
              <select id="model-select">
                <option value="gpt-4o-mini">GPT-4o Mini (Fast, Cost-effective)</option>
                <option value="gpt-4o">GPT-4o (Higher Quality)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
              </select>
              <div class="help-text">AI model for knowledge extraction</div>
            </div>
            
            <div id="ingest-btn-container">
              <button class="primary" id="ingest-btn" onclick="window.ingestionManager.ingestDocument()">
                üöÄ Extract Knowledge
              </button>
            </div>
            
            <div id="ingest-status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- VIEWING TAB (Graph Visualization) -->
  <div id="viewing-tab" class="tab-content">
    <div id="viewing-panel">
      <div id="cy-container">
        <div id="cy"></div>
        <div id="graph3d-container" class="graph3d-container hidden"></div>
        <div id="graph3d-ui" class="graph3d-ui hidden">
          <div class="graph3d-ui-group">
            <button class="graph3d-btn" id="btn-3d-fog" onclick="window.toggle3DFog()" title="Toggle Fog">üå´Ô∏è</button>
            <button class="graph3d-btn" id="btn-3d-layout" onclick="window.toggle3DLayout()" title="Run/Stop Force Layout">üß≤</button>
            <button class="graph3d-btn" id="btn-3d-reset" onclick="window.reset3DLayout()" title="Reset 3D Layout">üîÑ</button>
          </div>
          <div class="graph3d-ui-row">
            <label for="range-3d-size">Size</label>
            <input id="range-3d-size" type="range" min="0.8" max="3.0" step="0.1" value="1.6" oninput="window.set3DPointSize(this.value)" />
          </div>
        </div>
        
        <!-- Edge Hover Tooltip -->
        <div id="edge-tooltip">
          <div class="tooltip-header">
            <span id="tooltip-source"></span>
            <span class="tooltip-relation" id="tooltip-relation"></span>
            <span id="tooltip-target"></span>
          </div>
          <div class="tooltip-info" id="tooltip-confidence"></div>
          <div class="tooltip-info" id="tooltip-significance"></div>
          <button class="tooltip-btn" id="tooltip-read-more">üìñ Read More</button>
        </div>
        
        <!-- Node Hover Tooltip -->
        <div id="node-tooltip">
          <div class="tooltip-header" id="node-tooltip-label"></div>
          <div class="tooltip-info" id="node-tooltip-type"></div>
          <div class="tooltip-info" id="node-tooltip-significance"></div>
          <button class="tooltip-btn" id="node-tooltip-read-more">üìñ Read More</button>
        </div>
        
        <!-- FAB Container for 2-Node Actions -->
        <div id="fab-container-2node" class="hidden">
          <div class="fab-label">2 nodes selected</div>
          <button class="fab-btn" id="fab-create-relationship" onclick="window.appManager.createRelationship()" title="Create manual relationship between nodes">
            ‚ûï Create Relationship
          </button>
          <button class="fab-btn" id="fab-find-path" onclick="window.appManager.findPathBetweenNodes()" title="Find shortest path between nodes">
            üîó Find Path
          </button>
          <button class="fab-btn" id="fab-compare" onclick="window.appManager.compareNodes()" title="Compare selected nodes">
            ‚öñÔ∏è Compare
          </button>
          <button class="fab-btn" id="fab-merge" onclick="window.appManager.mergeNodes()" title="Merge selected nodes">
            üîÄ Merge
          </button>
        </div>
        
        <!-- Consolidated FAB Container - Bottom Left -->
        <div id="fab-container-left">
          <button id="index-toggle-btn" onclick="toggleIndex()" title="Toggle Index">üìã</button>
          <button id="legend-toggle-btn" onclick="toggleLegend()" title="Visual Guide">üìä</button>
          <button id="export-toggle-btn" onclick="window.appManager.openExport()" title="Export Graph">üíæ</button>
          <button id="review-toggle-btn" onclick="window.appManager.openReviewQueue()" title="Review Queue">‚úÖ</button>
          <button id="three-toggle-btn" onclick="window.toggle3D()" title="Toggle 2D / 3D">üß≠ 3D</button>
        </div>
      </div>
    </div>
    
    <!-- Index Panel -->
    <div id="index-panel" class="hidden">
      <div class="index-header">
        <h3 class="index-title">üìã Graph Index</h3>
        <div class="index-count" id="index-count">0 concepts, 0 relationships, 0 documents</div>
      </div>
      
      <!-- Index Filters -->
      <div class="index-filters">
        <input type="text" id="index-search" class="index-search-input" placeholder="üîç Search..." />
        <select id="index-view-filter" onchange="filterIndex()" class="index-filter-select">
          <option value="all">All Items</option>
          <option value="documents">Documents Only</option>
          <option value="concepts">Concepts Only</option>
          <option value="relationships">Relationships Only</option>
        </select>
        <select id="index-type-filter" onchange="filterIndex()" class="index-filter-select">
          <option value="">All Types</option>
        </select>
      </div>
      
      <div class="index-section" id="documents-section">
        <div class="index-section-title collapsible" onclick="window.viewingManager.indexManager.toggleSection('documents')">
          <span class="section-arrow">‚ñº</span>
          üìÑ Documents (<span id="documents-count">0</span>)
        </div>
        <div id="documents-list" class="index-section-content"></div>
      </div>
      
      <div class="index-section" id="concepts-section">
        <div class="index-section-title collapsible" onclick="window.viewingManager.indexManager.toggleSection('concepts')">
          <span class="section-arrow">‚ñº</span>
          üîµ Concepts (<span id="concepts-count">0</span>)
        </div>
        <ul class="index-list index-section-content" id="concepts-list"></ul>
      </div>
      
      <div class="index-section" id="relationships-section">
        <div class="index-section-title collapsible" onclick="window.viewingManager.indexManager.toggleSection('relationships')">
          <span class="section-arrow">‚ñº</span>
          üîó Relationships (<span id="relationships-count">0</span>)
        </div>
        <div id="relationships-list" class="index-section-content"></div>
      </div>
    </div>

  </div>

  <!-- Edge Details Modal -->
  <div id="edge-modal-overlay">
    <div id="edge-modal">
      <div class="modal-header">
        <h2 class="modal-title">Relationship Details</h2>
        <button class="modal-close" onclick="closeEdgeModal()">√ó</button>
      </div>
      <div class="modal-body" id="edge-modal-content"></div>
    </div>
  </div>
  
  <!-- Node Details Modal -->
  <div id="node-modal-overlay">
    <div id="node-modal">
      <div class="modal-header">
        <h2 class="modal-title">Node Details</h2>
        <button class="modal-close" onclick="closeNodeModal()">√ó</button>
      </div>
      <div class="modal-body" id="node-modal-content"></div>
    </div>
  </div>
  
  <!-- Document Details Modal -->
  <div id="document-modal-overlay">
    <div id="document-modal">
      <div class="modal-header">
        <h2 class="modal-title">Document Details</h2>
        <button class="modal-close" onclick="closeDocumentModal()">√ó</button>
      </div>
      <div class="modal-body" id="document-modal-content"></div>
    </div>
  </div>
  
  <!-- Create Relationship Modal -->
  <div id="create-edge-modal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Create Manual Relationship</h2>
        <button class="modal-close" onclick="window.appManager.closeCreateRelationshipModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="create-edge-form" onsubmit="window.appManager.saveManualRelationship(event)">
          <div class="form-group">
            <label>From (Subject)</label>
            <input type="text" id="manual-from" readonly class="readonly-input" />
          </div>
          
          <div class="form-group">
            <label>Relationship Type</label>
            <input type="text" id="manual-relation" list="manual-predicate-suggestions" required placeholder="e.g., targets, inhibits, activates..." />
            <datalist id="manual-predicate-suggestions">
              <option value="targets">
              <option value="inhibits">
              <option value="activates">
              <option value="regulates">
              <option value="binds_to">
              <option value="causes">
              <option value="treats">
              <option value="associated_with">
              <option value="located_in">
              <option value="part_of">
            </datalist>
          </div>
          
          <div class="form-group">
            <label>To (Object)</label>
            <input type="text" id="manual-to" readonly class="readonly-input" />
          </div>
          
          <div class="form-group">
            <label>Evidence / Source Text</label>
            <textarea id="manual-evidence" required class="evidence-textarea" placeholder="Provide the text or citation that supports this relationship..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Confidence (0-1)</label>
            <input type="number" id="manual-confidence" min="0" max="1" step="0.1" value="0.9" />
          </div>
          
          <div class="modal-footer">
            <button type="button" onclick="window.appManager.closeCreateRelationshipModal()" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Create Relationship</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Ingestion Progress Modal -->
  <div id="progress-modal" class="modal-overlay">
    <div class="modal-container progress-modal-container">
      <div class="modal-header">
        <h2 class="modal-title">üöÄ Knowledge Extraction in Progress</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeProgressModal()">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Email notification message -->
        <div class="email-notification">
          <div class="email-notification-inner">
            <span class="email-icon">üìß</span>
            <div class="email-text">
              <strong>Processing in background</strong><br>
              You'll receive an email summary with all extracted relationships when complete. Feel free to close this modal and continue working.
            </div>
          </div>
        </div>
        
        <!-- Overall progress -->
        <div class="modal-section">
          <div class="progress-header-row">
            <span class="progress-status" id="progress-modal-status">Queuing files...</span>
            <span class="progress-count" id="progress-modal-count">0 / 0</span>
          </div>
          <div class="progress-bar-wrapper">
            <div id="progress-modal-bar" class="progress-bar-inner"></div>
          </div>
          <div class="progress-percentage" id="progress-modal-percentage">0%</div>
        </div>
        
        <!-- File list -->
        <div class="modal-section">
          <div class="modal-section-title">Files</div>
          <div id="progress-modal-files" class="progress-files-list"></div>
        </div>
        
        <!-- Summary stats -->
        <div id="progress-modal-summary" class="progress-summary">
          <div class="progress-summary-title">Summary</div>
          <div class="progress-summary-grid">
            <div>‚úì Successful: <strong id="progress-summary-success">0</strong></div>
            <div>‚úó Failed: <strong id="progress-summary-failed">0</strong></div>
            <div class="progress-summary-full">üìä Total Relationships: <strong id="progress-summary-triplets">0</strong></div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" onclick="window.ingestionManager.closeProgressModal()" class="btn-primary" id="progress-modal-close-btn">
            Continue in Background
          </button>
        </div>
      </div>
    </div>

    <!-- Discovery Bulk Ingest Parameters Modal -->
    <div id="discovery-bulk-ingest-modal" class="modal-overlay">
      <div class="modal-container" style="max-width: 56rem;">
        <div class="modal-header">
          <h2 class="modal-title">Ingest Selected Papers ‚Äî Parameters</h2>
          <button class="modal-close" onclick="window.discoveryManager?.closeBulkIngestModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="discovery-bulk-use-graph-context" class="checkbox-input" />
              <span class="checkbox-text">Use Selected Graph as Context for All</span>
            </label>
            <div id="discovery-bulk-graph-context-status" class="graph-context-status hidden">
              <div class="graph-context-status-inner">
                <div>
                  <strong>Context Ready:</strong> <span id="discovery-bulk-graph-context-count">0</span> nodes selected
                </div>
                <button type="button" onclick="window.ingestionManager?.showContextPreview()" class="preview-btn">üëÅÔ∏è Preview</button>
              </div>
            </div>
          </div>
          <div id="discovery-bulk-list" style="max-height: 50vh; overflow: auto; display: grid; gap: 0.75rem;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="window.discoveryManager?.closeBulkIngestModal()">Cancel</button>
          <button type="button" class="btn-primary" onclick="window.discoveryManager?.startBulkIngestFromParams()">Ingest All</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Graph Context Configuration Modal -->
  <div id="context-config-modal" class="modal-overlay">
    <div class="modal-container" style="max-width: 900px; width: 90%;">
      <div class="modal-header">
        <h2 class="modal-title">üéØ Configure Graph Context for Extraction</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeContextConfig()">√ó</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Tabs -->
        <div style="display:flex; gap:8px; margin-bottom:12px;">
          <button id="context-tab-btn-graph" class="btn-secondary active" style="padding:8px 12px;" onclick="window.ingestionManager.switchContextTab('graph')">Graph Context</button>
          <button id="context-tab-btn-user" class="btn-secondary" style="padding:8px 12px;" onclick="window.ingestionManager.switchContextTab('user')">User Context</button>
        </div>

        <!-- Graph Context Pane -->
        <div id="context-tab-graph">
          <!-- Context Selection Section -->
          <div class="modal-section">
            <div class="modal-section-title">1. Select Context Source</div>
            <div class="modal-section-content">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                <label class="checkbox-label" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" id="context-use-selected-nodes" class="checkbox-input" onchange="window.ingestionManager.updateContextSummary()" />
                  <span class="checkbox-text">Selected Concepts (<span id="context-node-count">0</span>)</span>
                </label>
                <label class="checkbox-label" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" id="context-use-selected-edges" class="checkbox-input" onchange="window.ingestionManager.updateContextSummary()" />
                  <span class="checkbox-text">Selected Relationships (<span id="context-edge-count">0</span>)</span>
                </label>
                <label class="checkbox-label" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" id="context-use-filtered-view" class="checkbox-input" onchange="window.ingestionManager.updateContextSummary()" />
                  <span class="checkbox-text">Current Filtered View</span>
                </label>
                <label class="checkbox-label" style="padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                  <input type="checkbox" id="context-use-documents" class="checkbox-input" onchange="window.ingestionManager.updateContextSummary()" />
                  <span class="checkbox-text">Specific Documents</span>
                </label>
              </div>
              
              <!-- Document Selection (shown when context-use-documents is checked) -->
              <div id="context-document-selection" style="display: none; margin-top: 12px; padding: 12px; background: #f3f4f6; border-radius: 6px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Select Documents:</div>
                <div id="context-document-list" style="max-height: 150px; overflow-y: auto;"></div>
              </div>
              
              <div class="help-text" style="margin-top: 12px;">
                Select one or more sources to build your context. Use Shift+Click in the Viewer to select concepts/relationships.
              </div>
            </div>
          </div>
          
          <!-- Extraction Intent Section -->
          <div class="modal-section">
            <div class="modal-section-title">2. Specify Extraction Intent</div>
            <div class="modal-section-content">
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <label class="checkbox-label" style="padding: 10px; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="intent-complements" class="checkbox-input" checked />
                  <span class="checkbox-text">Find relationships that <strong>complement</strong> existing knowledge</span>
                </label>
                <label class="checkbox-label" style="padding: 10px; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="intent-conflicts" class="checkbox-input" checked />
                  <span class="checkbox-text">Find relationships that <strong>conflict with</strong> existing knowledge</span>
                </label>
                <label class="checkbox-label" style="padding: 10px; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="intent-extends" class="checkbox-input" checked />
                  <span class="checkbox-text">Find relationships that <strong>extend</strong> existing knowledge</span>
                </label>
                <label class="checkbox-label" style="padding: 10px; background: #f9fafb; border-radius: 6px; cursor: pointer;">
                  <input type="checkbox" id="intent-distinct" class="checkbox-input" />
                  <span class="checkbox-text">Find relationships <strong>distinct from</strong> existing knowledge</span>
                </label>
              </div>
              <div class="help-text" style="margin-top: 12px;">
                Select one or more intents to guide extraction. If none selected, extraction will be neutral.
              </div>
            </div>
          </div>
          
          <!-- Context Preview Section -->
          <div class="modal-section">
            <div class="modal-section-title">3. Preview Context</div>
            <div class="modal-section-content">
              <div id="context-preview-summary" style="padding: 12px; background: #f3f4f6; border-radius: 6px; font-size: 13px; color: #374151;">
                <div style="font-weight: 600; margin-bottom: 8px;">Context Summary:</div>
                <div id="context-preview-details">No context configured yet</div>
              </div>
              <button type="button" onclick="window.ingestionManager.showDetailedContextPreview()" class="btn-secondary" style="margin-top: 12px; width: 100%;">
                üëÅÔ∏è View Detailed Preview
              </button>
            </div>
          </div>
        </div>

        <!-- User Context Pane -->
        <div id="context-tab-user" style="display:none;">
          <div class="modal-section">
            <div class="modal-section-title">Your Focus/Instructions</div>
            <div class="modal-section-content">
              <textarea id="user-context-text" placeholder="Describe your focus, e.g., proteins and their functional relationships, drug-target interactions, disease mechanisms..." style="min-height: 160px; width: 100%;"></textarea>
              <div class="help-text" style="margin-top:8px;">This text will be included with the graph context (if enabled) to guide extraction.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="window.ingestionManager.clearContext()" class="btn-secondary">Clear Context</button>
        <button type="button" onclick="window.ingestionManager.closeContextConfig()" class="btn-secondary">Cancel</button>
        <button type="button" onclick="window.ingestionManager.applyContextConfig()" class="btn-primary">Apply Context</button>
      </div>
    </div>
  </div>
  
  <!-- Graph Context Preview Modal -->
  <div id="context-preview-modal" class="modal-overlay">
    <div class="modal-container context-preview-container">
      <div class="modal-header">
        <h2 class="modal-title">üìä Graph Context Preview</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeContextPreview()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <div class="modal-section-title">Selected Nodes (<span id="preview-node-count">0</span>)</div>
          <div id="preview-nodes-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Relationships (<span id="preview-rel-count">0</span>)</div>
          <div id="preview-relationships-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Neighbor Entities (<span id="preview-neighbor-count">0</span>)</div>
          <div id="preview-neighbors-list" class="modal-section-content"></div>
        </div>
        
        <div class="modal-section">
          <div class="modal-section-title">Context Text</div>
          <div class="modal-section-content">
            <div class="preview-raw-text" id="preview-raw-text"></div>
            <div class="preview-token-info">
              Estimated tokens: <strong id="preview-token-count">0</strong>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" onclick="window.ingestionManager.copyContextText()" class="btn-secondary">üìã Copy Text</button>
          <button type="button" onclick="window.ingestionManager.closeContextPreview()" class="btn-primary">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Visual Configuration Modal -->
  <div id="legend-modal-overlay">
    <div id="legend-modal">
      <div class="modal-header">
        <h2 class="modal-title">üé® Visual Configuration</h2>
        <button class="modal-close" onclick="closeLegendModal()">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Configuration Controls -->
        <div class="config-grid">
          <div class="config-section">
            <div class="config-section-title">Node Color Scheme</div>
            <div class="config-control">
              <select id="node-color-scheme" class="config-select" onchange="window.viewingManager.applyVisualConfig()">
                <option value="default">Default (Purple)</option>
                <option value="by-type">By Entity Type</option>
                <option value="by-user">By User/Creator</option>
                <option value="by-document">By Document Source</option>
                <option value="by-degree">By Connection Count</option>
              </select>
            </div>
            <div id="color-legend" class="color-legend-container"></div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Node Size</div>
            <div class="config-control">
              <select id="node-size-scheme" class="config-select" onchange="window.viewingManager.applyVisualConfig()">
                <option value="by-significance">By Significance (Default)</option>
                <option value="uniform">Uniform</option>
                <option value="by-degree">By Connection Count</option>
                <option value="by-importance">By Centrality</option>
              </select>
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Edge Style</div>
            <div class="config-control">
              <select id="edge-style-scheme" class="config-select" onchange="window.viewingManager.applyVisualConfig()">
                <option value="default">Default (Gray)</option>
                <option value="by-type">By Relationship Type</option>
                <option value="by-document">By Document Source</option>
              </select>
            </div>
            <div id="edge-legend" class="color-legend-container"></div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Label Display</div>
            <div class="config-control">
              <select id="label-display-scheme" class="config-select" onchange="window.viewingManager.applyVisualConfig()">
                <option value="hover">Show on Hover</option>
                <option value="always">Always Show</option>
                <option value="selected">Selected Only</option>
                <option value="never">Hide All</option>
              </select>
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Layout Algorithm</div>
            <div class="config-control">
              <select id="layout-algorithm" class="config-select" onchange="window.viewingManager.applyLayout()">
                <option value="cose">Force-Directed (COSE)</option>
                <option value="fcose">Fast Force-Directed</option>
                <option value="cola">Constraint-Based</option>
                <option value="circle">Circular</option>
                <option value="grid">Grid</option>
                <option value="concentric">Concentric</option>
                <option value="breadthfirst">Hierarchical (Breadth-First)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="config-actions">
          <button class="config-btn config-btn-secondary" onclick="window.viewingManager.resetVisualConfig()">Reset to Default</button>
          <button class="config-btn config-btn-primary" onclick="closeLegendModal()">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Relationship Legend Modal -->
  <div id="edge-legend-modal-overlay">
    <div id="edge-legend-modal" class="legend-detail-modal">
      <div class="modal-header">
        <h2 class="modal-title">Relationship Color Legend</h2>
        <button class="modal-close" id="edge-legend-modal-close" type="button">&times;</button>
      </div>
      <div class="modal-body" id="edge-legend-modal-body">
        <div class="legend-modal-summary">
          <strong id="edge-legend-count">0</strong> relationship styles
        </div>
        <div id="edge-legend-modal-list" class="color-legend-container visible"></div>
      </div>
      <div class="config-actions">
        <button class="config-btn config-btn-secondary" type="button" id="edge-legend-modal-done">Close</button>
      </div>
    </div>
  </div>

  <!-- Advanced Extraction Configuration Modal -->
  <div id="advanced-extraction-modal-overlay" class="modal-overlay">
    <div id="advanced-extraction-modal" class="modal-dialog">
      <div class="modal-header">
        <h2 class="modal-title">‚öôÔ∏è Advanced Extraction Settings</h2>
        <button class="modal-close" onclick="window.ingestionManager.closeAdvancedConfig()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">
          Fine-tune how the AI extracts knowledge from your documents. These settings modify the extraction prompt to emphasize different aspects of knowledge representation.
        </p>

        <div class="config-grid">
          <div class="config-section">
            <div class="config-section-title">Extraction Density</div>
            <div class="config-control">
              <select id="extraction-density" class="config-select">
                <option value="comprehensive">Comprehensive Network (Dense, Interconnected)</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="focused">Focused Triplets (Key Relationships Only)</option>
              </select>
            </div>
            <div class="config-help">
              <strong>Comprehensive:</strong> Extract many entities with rich interconnections, creating a dense knowledge network.<br>
              <strong>Focused:</strong> Extract only the most significant, direct relationships between key entities.
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Entity Granularity</div>
            <div class="config-control">
              <select id="entity-granularity" class="config-select">
                <option value="fine">Fine-grained (Specific Details)</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="coarse">Coarse-grained (Broad Concepts)</option>
              </select>
            </div>
            <div class="config-help">
              <strong>Fine-grained:</strong> Extract specific entities (e.g., "BRAF V600E mutation", "CD8+ T cells").<br>
              <strong>Coarse-grained:</strong> Extract broader concepts (e.g., "BRAF mutations", "T cells").
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Relationship Specificity</div>
            <div class="config-control">
              <select id="relationship-specificity" class="config-select">
                <option value="specific">Specific Predicates (Precise)</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="general">General Predicates (Broad)</option>
              </select>
            </div>
            <div class="config-help">
              <strong>Specific:</strong> Use precise predicates (e.g., "phosphorylates", "upregulates", "competitively_inhibits").<br>
              <strong>General:</strong> Use broader predicates (e.g., "affects", "relates_to", "modulates").
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Temporal Context</div>
            <div class="config-control">
              <select id="temporal-context" class="config-select">
                <option value="include">Include Temporal Markers</option>
                <option value="ignore" selected>Ignore Temporal Context (Default)</option>
              </select>
            </div>
            <div class="config-help">
              <strong>Include:</strong> Extract time-based relationships and temporal sequences (e.g., "occurs_before", "follows").<br>
              <strong>Ignore:</strong> Focus on static, timeless relationships.
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Confidence Threshold</div>
            <div class="config-control">
              <select id="confidence-threshold" class="config-select">
                <option value="high">High Confidence Only (Explicit)</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="permissive">Permissive (Include Inferred)</option>
              </select>
            </div>
            <div class="config-help">
              <strong>High:</strong> Extract only explicitly stated relationships with clear evidence.<br>
              <strong>Permissive:</strong> Include both explicit and strongly implied relationships from context.
            </div>
          </div>

          <div class="config-section">
          <div class="config-section-title">Relationship Polarity Emphasis</div>
          <div class="config-control">
            <select id="polarity-emphasis" class="config-select">
              <option value="negative">Negative Findings Emphasis</option>
              <option value="balanced" selected>Balanced (Default)</option>
              <option value="positive">Positive Findings Emphasis</option>
            </select>
          </div>
          <div class="config-help">
            Tune the balance between extracting negative vs. positive relationships.
          </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Evidence Style</div>
            <div class="config-control">
              <select id="evidence-style" class="config-select">
                <option value="verbatim">Verbatim Quotes (Exact Evidence)</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="summary">Summarized Evidence</option>
              </select>
            </div>
            <div class="config-help">
              Control whether supporting evidence should be verbatim quotes or concise summaries.
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Normalization Strictness</div>
            <div class="config-control">
              <select id="normalization-strictness" class="config-select">
                <option value="strict">Strict Ontology Mapping</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="natural">Natural Language Friendly</option>
              </select>
            </div>
            <div class="config-help">
              Choose between strict canonical predicate/entity terms vs. expressive natural language when informative.
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Novelty Preference</div>
            <div class="config-control">
              <select id="novelty-preference" class="config-select">
                <option value="novel">Prefer Novel Findings</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="confirmatory">Prefer Confirmatory Findings</option>
              </select>
            </div>
            <div class="config-help">
              Emphasize extracting knowledge that is new vs. confirming known relationships.
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-title">Causality Bias</div>
            <div class="config-control">
              <select id="causality-bias" class="config-select">
                <option value="causal">Prefer Causal Relationships</option>
                <option value="balanced" selected>Balanced (Default)</option>
                <option value="associative">Prefer Associative/Correlative</option>
              </select>
            </div>
            <div class="config-help">
              Bias extraction toward causal claims vs. associative relationships.
            </div>
          </div>
        </div>

        <div class="config-actions">
          <button class="config-btn config-btn-secondary" onclick="window.ingestionManager.resetAdvancedConfig()">Reset to Default</button>
          <button class="config-btn config-btn-primary" onclick="window.ingestionManager.closeAdvancedConfig()">Apply Settings</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- DISCOVERY TAB -->
  <div id="discovery-tab" class="tab-content">
    <div class="discovery-container">
      
      <!-- LEFT: Search Configuration -->
      <div class="discovery-search-panel">
        <form class="discovery-search-form" id="discovery-search-form">
          <div class="discovery-form-group">
            <label for="discovery-query">Research Query</label>
            <input 
              type="text" 
              id="discovery-query" 
              placeholder="e.g., machine learning protein folding"
              required
            />
          </div>
          
          <div class="discovery-search-options">
            <div class="discovery-form-group">
              <label for="discovery-max-results">Max Results Per Source</label>
              <input type="number" id="discovery-max-results" value="10" min="1" max="20" />
            </div>
            
            <div class="discovery-form-group">
              <label>Data Sources</label>
              <div class="discovery-sources-group">
                <div class="discovery-checkbox-group">
                  <input type="checkbox" id="discovery-source-pubmed" checked />
                  <label for="discovery-source-pubmed">üìö PubMed (Biomedical)</label>
                </div>
                <div class="discovery-checkbox-group">
                  <input type="checkbox" id="discovery-source-arxiv" checked />
                  <label for="discovery-source-arxiv">üìÑ ArXiv (Preprints)</label>
                </div>
                <div class="discovery-checkbox-group">
                  <input type="checkbox" id="discovery-source-semantic-scholar" />
                  <label for="discovery-source-semantic-scholar">üéì Semantic Scholar (All)</label>
                </div>
              </div>
              <small style="color: #666; font-size: 12px; margin-top: 5px;">Semantic Scholar may be rate-limited</small>
            </div>
            
            <div class="discovery-form-group">
              <label>Options</label>
              <div class="discovery-checkbox-group">
                <input type="checkbox" id="discovery-use-semantic-ranking" checked />
                <label for="discovery-use-semantic-ranking">ü§ñ AI Relevance Ranking</label>
              </div>
            </div>
          </div>
          
          <div class="discovery-button-group">
            <button type="submit" class="discovery-btn discovery-btn-primary" style="width: 100%;">üîç Search Papers</button>
          </div>
        </form>
      </div>
      
      <!-- RIGHT: Results -->
      <div class="discovery-results-panel" id="discovery-results-panel">
        <div class="discovery-results-header">
          <h3>Search Results</h3>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <span class="discovery-results-count" id="discovery-results-count">0 papers found</span>
            <button 
              id="discovery-ingest-button" 
              class="discovery-btn discovery-btn-primary discovery-btn-small" 
              style="display: none;"
              onclick="window.discoveryManager?.ingestSelected()">
              ‚ö° Ingest Selected (<span id="discovery-selected-count">0</span>)
            </button>
          </div>
        </div>
        
        <div id="discovery-results-container"></div>
      </div>
    </div>
    
    <!-- Paper Detail Modal -->
    <div class="discovery-modal-overlay" id="discovery-modal-overlay" onclick="window.discoveryManager?.closeModal(event)">
      <div class="discovery-modal" onclick="event.stopPropagation()">
        <div class="discovery-modal-header">
          <h2 class="discovery-modal-title" id="discovery-modal-title"></h2>
          <button class="discovery-modal-close" onclick="window.discoveryManager?.closeModal()">√ó</button>
        </div>
        <div class="discovery-modal-body" id="discovery-modal-body"></div>
        <div class="discovery-modal-footer">
          <button class="discovery-btn discovery-btn-secondary" onclick="window.discoveryManager?.closeModal()">Close</button>
          <button class="discovery-btn discovery-btn-primary" id="discovery-modal-ingest-btn" onclick="window.discoveryManager?.ingestFromModal()">
            ‚ö° Ingest This Paper
          </button>
        </div>
      </div>
    </div>

    <!-- Discovery Ingest Parameters Modal (Single Paper) -->
    <div id="discovery-ingest-modal" class="modal-overlay">
      <div class="modal-container">
        <div class="modal-header">
          <h2 class="modal-title">Ingest Paper ‚Äî Parameters</h2>
          <button class="modal-close" onclick="window.discoveryManager?.closeIngestParamsModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>User Context (optional)</label>
            <textarea id="discovery-user-context" placeholder="Describe your focus or constraints..."></textarea>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="discovery-use-graph-context" class="checkbox-input" />
              <span class="checkbox-text">Use Selected Graph as Context</span>
            </label>
            <div id="discovery-graph-context-status" class="graph-context-status hidden">
              <div class="graph-context-status-inner">
                <div>
                  <strong>Context Ready:</strong> <span id="discovery-graph-context-count">0</span> nodes selected
                </div>
                <button type="button" onclick="window.ingestionManager?.showContextPreview()" class="preview-btn">üëÅÔ∏è Preview</button>
              </div>
            </div>
          </div>
          <div class="param-grid">
            <div class="form-group">
              <label>Max Concepts</label>
              <input type="number" id="discovery-max-concepts" value="100" min="10" max="500" />
            </div>
            <div class="form-group">
              <label>Max Relationships</label>
              <input type="number" id="discovery-max-relationships" value="50" min="10" max="200" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="window.discoveryManager?.closeIngestParamsModal()">Cancel</button>
          <button type="button" class="btn-primary" onclick="window.discoveryManager?.startIngestFromParams()">Ingest</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AI QUERY TAB -->
  <div id="ai-query-tab" class="tab-content">
    <div id="ai-query-content">
      <!-- Content will be populated by ai-query.js -->
    </div>
  </div>

  <!-- Create Workspace Modal -->
  <div class="modal" id="app-create-workspace-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Workspace</h2>
        <button class="modal-close" id="app-create-close">&times;</button>
      </div>
      <form id="app-create-workspace-form">
        <div class="form-group">
          <label for="app-create-name">Name *</label>
          <input type="text" id="app-create-name" maxlength="100" required />
        </div>
        <div class="form-group">
          <label for="app-create-description">Description</label>
          <textarea id="app-create-description" rows="3" maxlength="500"></textarea>
        </div>
        <div class="form-group">
          <label>Icon</label>
          <div class="icon-selector" id="app-create-icon-selector"></div>
        </div>
        <div class="form-group">
          <label>Color</label>
          <div class="color-selector" id="app-create-color-selector"></div>
        </div>
        <div class="form-group">
          <label>Privacy</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="app-create-privacy" value="private" checked />
              <span>Private - Only invited members</span>
            </label>
            <label class="radio-label">
              <input type="radio" name="app-create-privacy" value="organization" />
              <span>Organization - Anyone in your org</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="button button-secondary" id="app-create-cancel">Cancel</button>
          <button type="submit" class="button button-primary" id="app-create-submit">Create Workspace</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Workspace Settings Modal -->
  <div class="modal" id="app-workspace-settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Workspace Settings</h2>
        <button class="modal-close" id="app-ws-settings-close">&times;</button>
      </div>
      <form id="app-workspace-settings-form">
        <div class="form-group">
          <label for="app-ws-name">Name</label>
          <input type="text" id="app-ws-name" maxlength="100" required />
        </div>
        <div class="form-group">
          <label for="app-ws-description">Description</label>
          <textarea id="app-ws-description" rows="3" maxlength="500"></textarea>
        </div>
        <div class="form-group">
          <label>Icon</label>
          <div class="icon-selector" id="app-ws-icon-selector"></div>
        </div>
        <div class="form-group">
          <label>Color</label>
          <div class="color-selector" id="app-ws-color-selector"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="button button-secondary" id="app-ws-settings-cancel">Cancel</button>
          <button type="submit" class="button button-primary" id="app-ws-settings-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- JavaScript Modules (ES6 Modules) -->
  <script src="/static/js/discovery/discovery.js"></script>
  <script type="module">
    import { WorkspaceSwitcher } from '/js/workspaces/workspace-switcher.js';
    // Initialize centered header modal switcher
    window.workspaceSwitcher = new WorkspaceSwitcher('workspace-switcher-container');
  </script>
  <script type="module" src="/static/js/main.js"></script>
</body>
</html>
